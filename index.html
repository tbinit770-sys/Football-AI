<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Football Analyst</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and dark theme -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* GitHub Dark BG */
            color: #c9d1d9; /* Light text color */
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col items-center">

    <div class="w-full max-w-2xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">Live Football Analyst</h1>
            <p class="text-gray-400 text-sm">Analysis using real-time web data via Google Search Grounding.</p>
        </header>

        <!-- Input Card -->
        <div class="bg-[#161b22] p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
            <textarea
                id="query-input"
                class="w-full h-24 p-3 bg-[#0d1117] text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 resize-none"
                placeholder="e.g., Analyze the current form of Inter Milan in Serie A and their next three fixtures."
            ></textarea>

            <button
                id="analyze-button"
                onclick="performAnalysis()"
                class="mt-4 w-full px-6 py-3 text-lg font-semibold rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 shadow-lg shadow-blue-500/50"
            >
                Analyze
            </button>
        </div>

        <!-- Analysis Report Card -->
        <div class="bg-[#161b22] p-6 rounded-xl shadow-2xl border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-blue-400">Analysis Report</h2>
            <div
                id="report-output"
                class="min-h-[150px] p-4 bg-[#0d1117] rounded-lg border border-gray-600 text-sm whitespace-pre-wrap"
            >
                Ready for analysis. Enter a query and click 'Analyze' to begin.
            </div>
            <div id="sources-output" class="mt-4 text-xs text-gray-500"></div>
        </div>
    </div>

    <script type="module">
        // Global variables provided by the Canvas environment
        const apiKey = "AIzaSyBBDxPo1ZNng4nKdlZAZDpravYnqzngO0c";
        const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';

        // DOM Elements
        const queryInput = document.getElementById('query-input');
        const analyzeButton = document.getElementById('analyze-button');
        const reportOutput = document.getElementById('report-output');
        const sourcesOutput = document.getElementById('sources-output');

        let isAnalyzing = false;

        /**
         * Converts the JSON grounding sources into a readable list of citations.
         * @param {Array<Object>} attributions - The grounding attributions array.
         * @returns {string} - HTML string of formatted sources.
         */
        function formatSources(attributions) {
            if (!attributions || attributions.length === 0) return '';
            
            const sources = attributions
                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                .filter(source => source.uri && source.title);

            if (sources.length === 0) return '';

            const uniqueSources = Array.from(new Set(sources.map(s => s.uri)))
                .map(uri => sources.find(s => s.uri === uri));

            const listItems = uniqueSources.map((source, index) => {
                const displayTitle = source.title || source.uri.substring(0, 50) + '...';
                return `<li class="truncate"><a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition duration-150">${displayTitle}</a></li>`;
            }).join('');

            return `<div class="mt-4 border-t border-gray-700 pt-3">
                        <p class="font-semibold text-gray-400 mb-1">Sources:</p>
                        <ul class="list-disc list-inside space-y-1">${listItems}</ul>
                    </div>`;
        }

        /**
         * Implements exponential backoff for retrying API calls.
         * @param {Function} fetcher - The function that performs the fetch request.
         * @param {number} maxRetries - Maximum number of retries.
         */
        async function fetchWithBackoff(fetcher, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetcher();
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit hit. Retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Do not log retry errors to console per instructions
                }
            }
        }


        /**
         * Performs the football analysis using the Gemini API with Google Search grounding.
         */
        window.performAnalysis = async function() {
            if (isAnalyzing) return;
            isAnalyzing = true;

            const userQuery = queryInput.value.trim();
            if (!userQuery) {
                reportOutput.innerHTML = `<span class="text-yellow-400">Please enter a query before analyzing.</span>`;
                isAnalyzing = false;
                return;
            }

            analyzeButton.disabled = true;
            analyzeButton.innerHTML = 'Analyzing... <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            reportOutput.innerHTML = 'Analyzing latest real-time data... Please wait.';
            sourcesOutput.innerHTML = '';


            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Enable Google Search grounding for real-time analysis
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: "You are a world-class football analyst. Based on the real-time data provided by your tools, provide a concise and insightful report on the requested team's current form, recent results, and upcoming fixtures. Use a professional, sports commentary tone." }]
                },
            };

            const fetcher = () => fetch(`${apiUrl}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            try {
                const response = await fetchWithBackoff(fetcher);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    reportOutput.innerHTML = text;

                    // Extract and display grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sourcesOutput.innerHTML = formatSources(groundingMetadata.groundingAttributions);
                    }
                } else {
                    const errorDetails = result.error?.message || "An unknown error occurred during analysis.";
                    reportOutput.innerHTML = `<span class="text-red-400">Analysis Failed:</span> ${errorDetails}`;
                }

            } catch (error) {
                console.error("API Fetch Error:", error);
                reportOutput.innerHTML = `<span class="text-red-400">Network Error:</span> Could not connect to the API. Please check your connection or try again later.`;
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = 'Analyze';
                isAnalyzing = false;
            }
        }

        // --- THE CRITICAL FIX IS HERE ---
        // There is NO call to performAnalysis() on window.onload or at the end of the script.
        // The script simply sets up the elements and the function, waiting for the user to click the button.
    </script>
</body>
</html>
